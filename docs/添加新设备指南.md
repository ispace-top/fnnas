# FnNAS 添加新设备完整指南

## 一、GitHub Actions 资源获取机制

### 1.1 系统基础镜像获取

GitHub Actions 通过以下方式获取 FnNAS 基础镜像：

#### 方式一：自动获取（默认）

**工作流程**：`.github/workflows/build-fnnas-image.yml` 第 299-405 行

```yaml
- name: Download fnnas image file
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  run: |
    # 从 ophub/fnnas releases 自动获取最新镜像
    latest_version=$(curl -s \
        -H "Accept: application/vnd.github+json" \
        -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
        https://api.github.com/repos/ophub/fnnas/releases?per_page=20 | \
        jq -r --arg RTK "fnnas_base_image" \
        --arg BOARD "${fnnas_base_version}" \
        '[.[] | select(.tag_name | contains($RTK))] |
        map(.assets[] | select(.name | contains($BOARD) and endswith(".img.xz"))) |
        sort_by(.updated_at) | reverse | .[0]')
```

**可用的基础镜像版本**（在 workflow_dispatch 中选择）：
- **Amlogic 系列**：`amlogic_338`、`amlogic_322`、`amlogic_300`
- **Allwinner 系列**：`allwinner_335`、`allwinner_317`
- **Rockchip 系列**：`rockchip_330`、`rockchip_321`、`rockchip_296`

#### 方式二：自定义 URL（手动指定）

在触发 GitHub Actions 时，可以通过 `fnnas_url` 参数指定自定义镜像下载地址：

```yaml
fnnas_url:
  description: "Custom fnnas image download url"
  required: false
  default: ""
```

**支持的格式**：
- GitHub Release URL：`https://github.com/owner/repo/releases/download/tag/filename.img.xz`
- 直接下载 URL：任何可通过 curl 下载的 HTTP/HTTPS 地址

### 1.2 DTB 和依赖文件获取

**脚本位置**：`renas` 中的 `download_depends()` 函数

#### 自动下载的资源：

1. **U-Boot 文件**
   - 来源：`https://github.com/ophub/u-boot`
   - 目标目录：`make-fnnas/u-boot/`
   - 内容：各平台 bootloader 二进制文件

2. **固件文件**
   - 来源：`https://github.com/ophub/firmware`
   - 目标目录：`make-fnnas/fnnas-files/common-files/usr/lib/firmware/`
   - 内容：WiFi、蓝牙等设备固件

3. **平台特定文件（包含 DTB）**
   - 来源：`https://github.com/ophub/amlogic-s9xxx-armbian`
   - 目标目录：`make-fnnas/fnnas-files/platform-files/`
   - 内容：
     - `amlogic/` - Amlogic 平台的 DTB、GRUB 配置
     - `rockchip/` - Rockchip 平台的 DTB、GRUB 配置
     - `allwinner/` - Allwinner 平台的 GRUB 配置

4. **设备差异化文件**
   - 来源：`https://github.com/ophub/amlogic-s9xxx-armbian`
   - 目标目录：`make-fnnas/fnnas-files/different-files/`
   - 内容：特定设备的配置覆盖文件

**下载流程**（renas 脚本执行时）：

```bash
download_depends() {
    # 1. 下载 u-boot
    git_pull_dir https://github.com/ophub/u-boot main ${git_path}
    cp -af ${git_path}/u-boot/. ${uboot_path}

    # 2. 下载固件
    git_pull_dir https://github.com/ophub/firmware main ${git_path}
    cp -af ${git_path}/firmware/. ${firmware_path}

    # 3. 下载 Armbian 仓库文件（包含 DTB）
    git_pull_dir https://github.com/ophub/amlogic-s9xxx-armbian main ${git_path}
    cp -af ${git_path}/build-armbian/armbian-files/platform-files/. ${platform_files}
    cp -af ${git_path}/build-armbian/armbian-files/different-files/. ${different_files}
}
```

---

## 二、添加新设备类型和 DTB 的完整步骤

### 2.1 前期准备

#### 需要收集的信息：

1. **硬件信息**：
   - SOC 型号（如 s905x3、rk3588、h6）
   - 内存大小
   - 存储类型（eMMC、SD、NVMe）
   - 网络接口（有线、WiFi）
   - 其他外设（SATA、USB 数量等）

2. **DTB 文件**：
   - 设备树文件名（如 `meson-sm1-x96-max-plus.dtb`）
   - DTB 文件来源（官方固件提取或社区编译）

3. **Bootloader 信息**：
   - U-Boot 文件名（如 `u-boot-x96maxplus.bin`）
   - 是否需要主线 U-Boot

4. **启动配置**：
   - 使用 `uEnv.txt` 还是 `extlinux.conf`
   - 是否需要特殊分区配置

### 2.2 第一步：在设备数据库中添加设备条目

**文件**：`make-fnnas/fnnas-files/common-files/etc/model_database.conf`

#### 格式说明（15 个字段）：

```
ID | MODEL | SOC | FDTFILE | UBOOT_OVERLOAD | MAINLINE_UBOOT | BOOTLOADER_IMG | DESCRIPTION | KERNEL_TAGS | PLATFORM | FAMILY | BOOT_CONF | CONTRIBUTORS | BOARD | BUILD
```

#### 示例（添加一个新的 S905X3 设备 "NewBox-Pro"）：

```conf
501:NewBox-Pro:s905x3:meson-sm1-newbox-pro.dtb:u-boot-x96maxplus.bin:NA:NA:4GB-RAM,32GB-eMMC,1Gb-Nic:stable/all:amlogic:meson-sm1:uEnv.txt:YourGitHub:s905x3-newbox:yes
```

#### 字段解释：

| 字段 | 值 | 说明 |
|------|-----|------|
| ID | 501 | 唯一设备 ID（选择未使用的编号，建议 500+） |
| MODEL | NewBox-Pro | 设备型号名称 |
| SOC | s905x3 | 芯片型号 |
| FDTFILE | meson-sm1-newbox-pro.dtb | DTB 文件名 |
| UBOOT_OVERLOAD | u-boot-x96maxplus.bin | U-Boot 文件名（Amlogic 使用） |
| MAINLINE_UBOOT | NA | 主线 U-Boot（通常为 NA） |
| BOOTLOADER_IMG | NA | Bootloader 镜像（特殊设备使用） |
| DESCRIPTION | 4GB-RAM,32GB-eMMC,1Gb-Nic | 硬件描述 |
| KERNEL_TAGS | stable/all | 内核兼容标签 |
| PLATFORM | amlogic | 平台（amlogic/rockchip/allwinner） |
| FAMILY | meson-sm1 | SOC 系列 |
| BOOT_CONF | uEnv.txt | 启动配置格式 |
| CONTRIBUTORS | YourGitHub | 贡献者 GitHub 用户名 |
| BOARD | s905x3-newbox | 板型标识符（用于 `-b` 参数） |
| BUILD | yes | 是否包含在 `all` 构建中 |

#### 内核兼容标签选择：

| KERNEL_TAGS | 适用场景 |
|-------------|----------|
| `stable/all` | 支持所有 stable 内核版本（推荐） |
| `stable/6.x.y` | 仅支持 6.1.y、6.6.y、6.12.y |
| `stable/5.x.y` | 仅支持 5.10.y、5.15.y（老设备） |
| `rk3588/6.1.y` | Rockchip RK3588 专用内核 |
| `rk35xx/6.1.y` | Rockchip RK3528/RK3566/RK3568 |
| `h6/6.6.y` | Allwinner H6 专用内核 |

### 2.3 第二步：准备 DTB 文件

#### 方式一：使用现有 DTB（推荐）

如果设备与现有设备高度兼容，可以直接使用已有的 DTB 文件：

1. 查看 `ophub/amlogic-s9xxx-armbian` 仓库中是否有合适的 DTB
2. 确认 DTB 文件会在 `download_depends()` 时自动下载到：
   ```
   make-fnnas/fnnas-files/platform-files/{platform}/bootfs/dtb/
   ```

#### 方式二：添加自定义 DTB

如果需要自定义 DTB 文件：

1. **本地添加**（用于本地构建）：
   ```bash
   # 将 DTB 文件放入平台目录
   cp your-device.dtb make-fnnas/fnnas-files/platform-files/amlogic/bootfs/dtb/amlogic/
   ```

2. **提交到上游**（用于 GitHub Actions）：

   **方法 A：提交到 ophub/amlogic-s9xxx-armbian**

   Fork `ophub/amlogic-s9xxx-armbian` 仓库，添加 DTB 文件到：
   ```
   build-armbian/armbian-files/platform-files/amlogic/bootfs/dtb/amlogic/
   ```
   提交 Pull Request 到上游仓库。

   **方法 B：在本仓库中添加**

   在本项目中创建 DTB 文件：
   ```bash
   mkdir -p make-fnnas/fnnas-files/platform-files/amlogic/bootfs/dtb/amlogic/
   cp your-device.dtb make-fnnas/fnnas-files/platform-files/amlogic/bootfs/dtb/amlogic/
   git add make-fnnas/fnnas-files/platform-files/
   git commit -m "Add: 添加 NewBox-Pro DTB 支持"
   ```

### 2.4 第三步：创建设备特定配置（可选）

如果设备需要特殊配置，创建差异化配置目录：

```bash
mkdir -p make-fnnas/fnnas-files/different-files/s905x3-newbox/rootfs/etc/
```

#### 创建设备配置文件：

**文件**：`make-fnnas/fnnas-files/different-files/s905x3-newbox/rootfs/etc/fnnas-board-release.conf`

```bash
#===========================================================================
# NewBox-Pro 设备配置
# 4GB-RAM, 32GB-eMMC, 1Gb-Nic
#
# MODEL_ID="501"
# MODEL_BOARD="s905x3-newbox"
# SOC="s905x3"
#===========================================================================

# 设置跳过分区大小（如果需要特殊分区）
skip_mb="16"

# 设置 bootloader 写入命令（如果需要）
write_board_file="no"
# write_board_bootloader() {
#     dd if="${bootloader_path}/${board}/u-boot.bin" of="${loop_new}" \
#        conv=fsync,notrunc bs=1 count=444 2>/dev/null
#     dd if="${bootloader_path}/${board}/u-boot.bin" of="${loop_new}" \
#        conv=fsync,notrunc bs=512 skip=1 seek=1 2>/dev/null
# }
```

#### 其他可选配置文件：

1. **网络配置**：
   ```bash
   different-files/s905x3-newbox/rootfs/etc/network/interfaces
   ```

2. **设备树覆盖**：
   ```bash
   different-files/s905x3-newbox/bootfs/dtb/amlogic/overlay/
   ```

3. **自定义脚本**：
   ```bash
   different-files/s905x3-newbox/rootfs/usr/sbin/device-init.sh
   ```

### 2.5 第四步：准备 U-Boot 文件（Amlogic 设备）

#### 检查 U-Boot 可用性：

1. 查看 `make-fnnas/u-boot/` 目录是否已有所需文件
2. 或检查 `ophub/u-boot` 仓库

#### 如果需要新的 U-Boot：

**方法一：使用现有兼容的 U-Boot**

大多数 S905X3 设备可以使用 `u-boot-x96maxplus.bin`，在 model_database.conf 中指定即可。

**方法二：添加新的 U-Boot**

1. 获取 U-Boot 二进制文件（从官方固件提取或编译）
2. 本地添加：
   ```bash
   cp u-boot-newbox.bin make-fnnas/u-boot/amlogic/
   ```
3. 提交到 `ophub/u-boot` 仓库（用于 GitHub Actions）

### 2.6 第五步：测试构建

#### 本地测试：

```bash
# 1. 准备基础镜像
mkdir -p fnnas-arm64
# 下载或复制 FnNAS 基础镜像到 fnnas-arm64/

# 2. 为新设备构建
sudo ./renas -b s905x3-newbox -k 6.12.63

# 3. 检查输出
ls -lh fnnas/out/
# 应该看到：fnnas_NewBox-Pro_6.12.63_*.img.gz
```

#### 验证构建结果：

```bash
# 解压并检查镜像
gunzip -c fnnas/out/fnnas_*.img.gz > test.img

# 挂载验证
sudo losetup -fP test.img
sudo mount /dev/loop0p2 /mnt
ls /mnt/boot/dtb/amlogic/  # 检查 DTB 是否存在
ls /mnt/usr/lib/firmware/  # 检查固件
sudo umount /mnt
sudo losetup -d /dev/loop0
```

### 2.7 第六步：GitHub Actions 集成

#### 更新工作流配置（如需要）：

**文件**：`.github/workflows/build-fnnas-image.yml`

在 `fnnas_board` 的 `options` 列表中添加新设备：

```yaml
fnnas_board:
  description: "Select fnnas device board"
  required: false
  default: "all"
  type: choice
  options:
    - all
    - s905x3-newbox  # 添加新设备
    # ... 其他设备
```

#### 提交更改：

```bash
git config user.name "isapce"
git config user.email ""
git add make-fnnas/fnnas-files/common-files/etc/model_database.conf
git add make-fnnas/fnnas-files/different-files/s905x3-newbox/
git add make-fnnas/fnnas-files/platform-files/amlogic/bootfs/dtb/amlogic/
git commit -m "Add: 添加 NewBox-Pro (s905x3) 设备支持"
git push
```

#### 触发 GitHub Actions 构建：

1. 进入仓库 Actions 页面
2. 选择 "Build FnNAS Image"
3. 点击 "Run workflow"
4. 选择参数：
   - `fnnas_base_version`: `amlogic_338`
   - `fnnas_board`: `s905x3-newbox`
   - `fnnas_kernel`: `6.12.y`
5. 点击 "Run workflow" 开始构建

---

## 三、不同平台设备的特殊说明

### 3.1 Amlogic 设备

**特点**：
- 需要 U-Boot 文件（UBOOT_OVERLOAD 字段）
- 使用 `uEnv.txt` 或 `extlinux.conf` 启动配置
- DTB 路径：`bootfs/dtb/amlogic/`

**常见 SOC 系列**：
- `meson-gxl`: s905d, s905x, s905w, s905l, s912
- `meson-gxm`: s912
- `meson-g12a`: s905x2, s905d2
- `meson-g12b`: s922x
- `meson-sm1`: s905x3, s905d3

### 3.2 Rockchip 设备

**特点**：
- 使用 GRUB 启动
- 可能需要 TRUST_IMG（UBOOT_OVERLOAD 字段）
- DTB 路径：`bootfs/dtb/rockchip/`

**常见 SOC**：
- rk3588, rk3568, rk3566, rk3399, rk3328, rk3528

**KERNEL_TAGS 建议**：
- RK3588: `rk3588/6.1.y`
- RK35xx 系列: `rk35xx/6.1.y`
- RK3399/RK3328: `stable/6.x.y`

### 3.3 Allwinner 设备

**特点**：
- 使用 GRUB 启动
- 不使用 UBOOT_OVERLOAD（设为 NA）
- DTB 路径：`bootfs/dtb/allwinner/`

**常见 SOC**：
- h6, h618

**KERNEL_TAGS**：
- H6: `h6/6.6.y`
- 其他: `stable/all`

---

## 四、常见问题和解决方案

### Q1: DTB 文件从哪里获取？

**答案**：
1. **官方固件提取**：从设备原厂 Android 固件中提取
2. **Linux 内核源码编译**：从主线内核或厂商内核编译
3. **社区分享**：在 Armbian 论坛、GitHub issues 中搜索
4. **修改现有 DTB**：使用 dtc 工具修改类似设备的 DTB

### Q2: GitHub Actions 构建失败，提示找不到 DTB？

**排查步骤**：
1. 确认 DTB 文件名在 model_database.conf 中正确
2. 检查 DTB 是否存在于 `ophub/amlogic-s9xxx-armbian` 仓库
3. 如果是自定义 DTB，确保已提交到本仓库的 platform-files
4. 查看 Actions 日志中的 `download_depends` 步骤是否成功

### Q3: 如何为设备添加专用内核？

**步骤**：
1. 修改 KERNEL_TAGS 为特定标签（如 `rk3588/6.1.y`）
2. 确保 `ophub/kernel` 仓库中存在对应内核标签
3. 或在 `ophub/fnnas` 的 releases 中上传自定义内核

### Q4: 新设备启动失败怎么办？

**调试方法**：
1. 通过串口查看启动日志
2. 检查 U-Boot 是否正确加载
3. 验证 DTB 文件是否与硬件匹配
4. 尝试使用 `extlinux.conf` 代替 `uEnv.txt`（或反之）
5. 参考类似设备的配置

### Q5: 如何贡献新设备支持到上游？

**流程**：
1. Fork `ophub/fnnas` 仓库
2. 按本指南添加设备支持
3. 测试构建成功
4. 提交 Pull Request，说明：
   - 设备型号和硬件规格
   - 测试结果（截图或日志）
   - 参考资料（如官方固件链接）

---

## 五、完整示例：添加 Orange Pi Zero3 (H618)

### 步骤 1：添加到 model_database.conf

```conf
707:Orange-Pi-Zero3:h618:sun50i-h618-orangepi-zero3.dtb:NA:NA:NA:1GB-RAM,1Gb-Nic:h6/6.6.y:allwinner:sun50i-h618:grubenv:ophub:orangepi-zero3:yes
```

### 步骤 2：准备 DTB

DTB 文件已存在于 `ophub/amlogic-s9xxx-armbian` 仓库中，无需手动添加。

### 步骤 3：创建设备配置（可选）

```bash
mkdir -p make-fnnas/fnnas-files/different-files/orangepi-zero3/rootfs/etc/
```

创建 `fnnas-board-release.conf`：

```bash
# Orange Pi Zero3 配置
# 1GB-RAM, MicroSD, 1Gb-Nic
# SOC="h618"
skip_mb="16"
write_board_file="no"
```

### 步骤 4：本地测试构建

```bash
sudo ./renas -b orangepi-zero3 -k 6.6.y
```

### 步骤 5：提交更改

```bash
git add make-fnnas/fnnas-files/common-files/etc/model_database.conf
git add make-fnnas/fnnas-files/different-files/orangepi-zero3/
git commit -m "Add: 添加 Orange Pi Zero3 (h618) 支持"
git push
```

### 步骤 6：GitHub Actions 构建

选择 `allwinner_335` 基础镜像，`orangepi-zero3` 板型，`6.6.y` 内核。

---

## 六、资源链接

- **DTB 文件源**：[ophub/amlogic-s9xxx-armbian](https://github.com/ophub/amlogic-s9xxx-armbian/tree/main/build-armbian/armbian-files/platform-files)
- **U-Boot 文件**：[ophub/u-boot](https://github.com/ophub/u-boot)
- **内核发布**：[ophub/fnnas/releases/tag/kernel_fnnas](https://github.com/ophub/fnnas/releases/tag/kernel_fnnas)
- **固件文件**：[ophub/firmware](https://github.com/ophub/firmware)
- **基础镜像**：[ophub/fnnas/releases/tag/fnnas_base_image](https://github.com/ophub/fnnas/releases/tag/fnnas_base_image)
- **设备兼容性讨论**：[ophub/amlogic-s9xxx-armbian/issues](https://github.com/ophub/amlogic-s9xxx-armbian/issues)

---

## 七、总结

添加新设备的核心步骤：

1. ✅ 在 `model_database.conf` 中添加设备条目
2. ✅ 确保 DTB 文件可用（自动下载或手动添加）
3. ✅ 准备 U-Boot 文件（Amlogic 设备）
4. ✅ 创建设备特定配置（如需要）
5. ✅ 本地测试构建
6. ✅ 提交代码并通过 GitHub Actions 构建

**关键原则**：
- 参考现有类似设备的配置
- 优先使用现有的 DTB 和 U-Boot
- 详细记录硬件信息和测试结果
- 遵循项目代码规范（无 AI 痕迹）
