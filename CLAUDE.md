# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 在此仓库中工作时提供指导。

## 项目概述

FnNAS 是一个基于 Debian 的深度定制 Linux NAS 操作系统，可将电视盒子和单板计算机转变为功能完善的网络存储服务器。本仓库提供构建工具，可为 400 多种设备型号打包 FnNAS 镜像，涵盖三种 CPU 架构：Amlogic、Rockchip 和 Allwinner。

## 开发规范

### 代码和提交规范

**重要：所有代码和提交必须遵循以下规范**

1. **禁止 AI 署名**：
   - 代码中不得出现任何 Claude、ChatGPT 或其他 AI 助手的署名
   - 注释中不得包含 "Generated by"、"AI-generated"、"Co-Authored-By: Claude" 等 AI 痕迹
   - 提交信息中不得提及 AI 工具的使用

2. **Git 提交配置**：
   - 提交署名使用：`isapce`
   - 提交邮箱留空或使用：`<>`
   - 配置示例：
     ```bash
     git config user.name "isapce"
     git config user.email ""
     ```

3. **代码风格**：
   - 保持与现有代码库一致的风格
   - 注释应简洁实用，避免冗余说明
   - 变量和函数命名遵循项目现有约定

4. **提交信息格式**：
   - 使用简洁的中文或英文描述
   - 格式：`<类型>: <简短描述>`
   - 示例：
     - `Add: 添加 Orange Pi Zero3 支持`
     - `Fix: 修复 btrfs 挂载参数缺失`
     - `Update: 更新内核到 6.12.63`

## 构建命令

### 打包 FnNAS 镜像

主打包脚本：`./renas`

```bash
# 基础用法 - 为特定板型和内核打包
sudo ./renas -b s905x3 -k 6.12.63

# 为多个板型打包
sudo ./renas -b s905x3_s905d -k 6.12.63

# 使用系列最新内核打包
sudo ./renas -b s905x3 -k 6.12.y -a true

# 为所有板型使用多个内核打包
sudo ./renas -k 6.12.63_6.18.3

# 自定义镜像大小（MiB）
sudo ./renas -b s905x3 -k 6.12.63 -s 6144

# 添加构建者签名
sudo ./renas -b s905x3 -k 6.12.63 -n "YourName"
```

**关键参数**：
- `-b [BOARD]`：设备板型代码（来自 model_database.conf）。使用 `_` 分隔多个板型，或特殊值：`all`、`first50`、`from50`、`last20`
- `-k [KERNEL]`：内核版本（如 `6.12.63`、`6.12.y`、`6.x.y`）。使用 `_` 指定多个内核
- `-a [yes/no]`：自动升级到同系列最新内核（默认：`yes`）
- `-r [owner/repo]`：GitHub 内核仓库（默认：`ophub/fnnas`）
- `-s [SIZE]`：ROOTFS 分区大小（MiB），或 `BOOTFS/ROOTFS`（默认：`512/6144`）
- `-n [NAME]`：构建者签名

### 编译/打包 FnNAS 内核

内核编译脚本：`./rekernel`

```bash
# 基础用法
sudo ./rekernel

# 打包前安装平台特定的 .deb 内核包
sudo ./rekernel -e amlogic
sudo ./rekernel -e rockchip
sudo ./rekernel -e allwinner

# 安装额外的 dtbs 文件
sudo ./rekernel -t true

# 自定义内核版本
sudo ./rekernel -k 6.12.63

# 组合示例
sudo ./rekernel -k 6.12.63 -e amlogic -t true
```

**关键参数**：
- `-r [owner/repo]`：GitHub debs 仓库（默认：`ophub/fnnas`）
- `-k [VERSION]`：内核版本（默认：`6.12.y`）
- `-e [PLATFORM]`：安装官方 .deb 包：`amlogic`、`rockchip`、`allwinner`、`none`（默认：`none`）
- `-t [yes/no]`：安装额外的 dtbs 文件（默认：`no`）

### 系统工具（部署在 FnNAS 镜像中）

这些命令在 FnNAS 系统内运行（通过 SSH）：

```bash
# 将 FnNAS 安装到 eMMC（从 USB/SD 启动）
fnnas-install
fnnas-install -m yes -a no  # 使用主线 u-boot，跳过 ampart

# 更新内核（自动备份最近 3 个版本）
fnnas-update
fnnas-update -k 6.12.63     # 指定版本
fnnas-update -k 6.12.y      # 6.12 系列最新版本
fnnas-update -s             # SOS：恢复系统内核

# 创建 swap 虚拟内存（参数单位为 GB）
fnnas-swap 1

# 备份/恢复 eMMC 安卓系统
fnnas-ddbr  # 然后按提示操作：'b' 备份，'r' 恢复

# 同步服务脚本到最新版本
fnnas-sync

# 配置 LED 屏幕显示
fnnas-openvfd
```

### 开发环境设置

安装构建依赖（Ubuntu 24.04）：

```bash
sudo apt-get update -y
sudo apt-get full-upgrade -y
sudo apt-get install -y $(cat make-fnnas/script/ubuntu2404-make-fnnas-depends)
```

## 架构和代码组织

### 目录结构

```
fnnas/
├── renas                          # 主镜像打包脚本
├── rekernel                       # 内核编译/打包脚本
├── action.yml                     # GitHub Actions 复合动作
├── make-fnnas/                    # 构建系统资源
│   ├── scripts/
│   │   ├── chroot_fnnas.sh        # 内核编译的 chroot 环境
│   │   └── ubuntu2404-make-fnnas-depends  # 依赖列表
│   ├── fnnas-files/
│   │   ├── common-files/          # 部署到所有设备的文件
│   │   │   ├── etc/
│   │   │   │   ├── model_database.conf    # 关键：设备数据库（400+ 型号）
│   │   │   │   ├── rc.local               # 启动初始化
│   │   │   │   ├── fstab                  # 文件系统挂载配置
│   │   │   │   └── custom_service/        # 服务启动钩子
│   │   │   └── usr/sbin/                  # 系统工具（fnnas-*）
│   │   ├── platform-files/        # 平台特定文件
│   │   │   ├── amlogic/           # Amlogic bootloader、GRUB、DTB
│   │   │   ├── rockchip/          # Rockchip bootloader、GRUB
│   │   │   └── allwinner/         # Allwinner GRUB 配置
│   │   └── different-files/       # 设备特定覆盖
│   │       ├── a311d-oes/
│   │       └── s922x-oes-plus/
│   ├── kernel/                    # 可选：预下载的内核
│   └── u-boot/                    # 可选：Bootloader 二进制文件
├── fnnas-arm64/                   # 输入：基础 FnNAS 镜像（*.img.xz）
├── fnnas/                         # 输出：构建产物
│   ├── tmp/                       # 临时工作目录
│   └── out/                       # 最终打包镜像
├── fnnas-debs/                    # 内核 .deb 包（用于 rekernel）
└── fnnas-dtbs/                    # 设备树文件（可选）
```

### 镜像组合策略

FnNAS 使用分层组合方式：

1. **基础层**：通用 Arm64 FnNAS rootfs 镜像（`fnnas-arm64/*.img.xz`）
2. **通用层**：`common-files/` - 应用于所有设备
3. **平台层**：`platform-files/{amlogic|rockchip|allwinner}/` - CPU 架构特定
4. **设备层**：`different-files/[board]/` - 单个设备覆盖
5. **结果**：`fnnas/out/` 中的设备特定可启动镜像

### 设备数据库（model_database.conf）

**位置**：`make-fnnas/fnnas-files/common-files/etc/model_database.conf`

设备数据库是定义所有支持硬件的中央注册表。每个设备条目包含 15 个管道分隔字段：

```
ID | MODEL | SOC | FDTFILE | UBOOT_OVERLOAD | MAINLINE_UBOOT | BOOTLOADER_IMG | DESCRIPTION | KERNEL_TAGS | PLATFORM | FAMILY | BOOT_CONF | CONTRIBUTORS | BOARD | BUILD
```

**关键概念**：
- **BOARD**（第 14 列）：与 `-b` 参数一起使用的标识符
- **SOC**（第 3 列）：片上系统（s905d、s922x、rk3588、h6 等）
- **KERNEL_TAGS**（第 9 列）：指定兼容的内核系列
  - `stable/all` → kernel_stable（任何版本）
  - `stable/6.x.y` → kernel_stable（仅 6.1.y、6.6.y、6.12.y）
  - `stable/5.x.y` → kernel_stable（仅 5.10.y、5.15.y）
  - `rk3588/6.1.y` → kernel_rk3588（6.1.y 系列）
  - `rk35xx/6.1.y` → kernel_rk35xx（用于 rk3528/rk3566/rk3568）
  - `h6/6.6.y` → kernel_h6（用于 Allwinner H6）
- **PLATFORM**（第 10 列）：amlogic、rockchip、allwinner
- **BOOT_CONF**（第 12 列）：启动配置格式（uEnv.txt、extlinux.conf）
- **BUILD**（第 15 列）：`yes` = 包含在 `-b all` 构建中

**选择逻辑**：
- `-b all`：构建所有 BUILD=yes 的设备
- `-b first50`：前 50 个 BUILD=yes 的设备
- `-b s905x3`：精确板型匹配（忽略 BUILD 标志）
- `-b s905x3_s922x`：多个板型

### 构建工作流

**本地打包流程**（renas）：

```
1. 输入准备
   - 定位基础镜像：fnnas-arm64/*.img.xz
   - 解析命令行参数

2. 资源下载（自动）
   - 内核：ophub/fnnas → releases/tag/kernel_fnnas
   - U-Boot：ophub/u-boot → releases
   - 固件：ophub/firmware → releases
   - 依赖：ophub/amlogic-s9xxx-armbian

3. 镜像提取
   - 根据需要解压 .xz/.gz
   - 循环挂载 BOOTFS 和 ROOTFS 分区

4. 文件部署（针对每个目标板型）
   - 复制 common-files/ → 所有设备
   - 复制 platform-files/[platform]/ → 平台特定
   - 复制 different-files/[board]/ → 设备覆盖
   - 覆盖顺序：通用 → 平台 → 设备（后者优先）

5. 内核替换
   - 从下载的包中提取 kernel/initrd
   - 更新设备树文件（DTB）
   - 调整 vmlinuz 加载地址（Amlogic 特定）

6. 启动配置
   - 生成 uEnv.txt（Amlogic/Allwinner）
   - 生成 extlinux.conf（某些设备）
   - 更新 GRUB 配置（Rockchip）

7. Root 文件系统重构
   - 更新 /etc/hostname、/etc/issue
   - 配置网络设置
   - 设置发布版本

8. 清理和打包
   - 卸载分区
   - 分离循环设备
   - 压缩（.gz 或 .xz）
   - 输出 → fnnas/out/
```

**内核编译流程**（rekernel）：

```
1. 挂载基础 FnNAS 镜像
2. 下载 .deb 包（如果指定了 -e）
3. 下载 dtbs 文件（如果指定了 -t）
4. 进入 chroot 环境（chroot_fnnas.sh）
5. 生成内核产物
6. 打包输出
7. 清理和卸载
```

### GitHub Actions CI/CD

**工作流文件**：
- `.github/workflows/build-fnnas-image.yml` - 自动化镜像构建
- `.github/workflows/build-fnnas-kernel.yml` - 内核编译流水线

**Action 参数**（action.yml）：

```yaml
inputs:
  build_target: fnnas | kernel
  fnnas_path: 基础镜像的路径或 URL
  fnnas_board: 设备板型代码（默认：all）
  fnnas_kernel: 内核版本（默认：6.1.y_6.12.y）
  auto_kernel: 自动升级内核（默认：true）
  fnnas_size: 分区大小（MiB）（默认：512/6144）
  debs_version: debs 的内核版本（默认：6.12.y）
  debs_install: deb 安装平台（默认：none）
  dtbs_install: 安装 dtbs 文件（默认：false）
```

**环境变量输出**：
- `PACKAGED_OUTPUTPATH`：输出目录路径
- `PACKAGED_OUTPUTDATE`：打包时间戳（mm.dd.hhmm）
- `PACKAGED_STATUS`：success | failure

## 添加新设备支持

**详细指南**：请参阅 [docs/添加新设备指南.md](docs/添加新设备指南.md)

### 快速步骤：

1. **在 model_database.conf 中添加设备条目**：
   ```
   501:NewDevice-Model:s905x3:meson-sm1-newbox-pro.dtb:u-boot-x96maxplus.bin:NA:NA:4GB-RAM,32GB-eMMC,1Gb-Nic:stable/all:amlogic:meson-sm1:uEnv.txt:YourGitHub:s905x3-newbox:yes
   ```

   **15 个字段说明**：ID | MODEL | SOC | FDTFILE | UBOOT_OVERLOAD | MAINLINE_UBOOT | BOOTLOADER_IMG | DESCRIPTION | KERNEL_TAGS | PLATFORM | FAMILY | BOOT_CONF | CONTRIBUTORS | BOARD | BUILD

2. **准备 DTB 文件**：
   - 自动下载：DTB 来自 `ophub/amlogic-s9xxx-armbian` 仓库，会在构建时自动下载
   - 手动添加：将 DTB 放入 `make-fnnas/fnnas-files/platform-files/{platform}/bootfs/dtb/`

3. **创建设备特定配置**（可选）：
   ```bash
   mkdir -p make-fnnas/fnnas-files/different-files/s905x3-newbox/rootfs/etc/
   # 创建 fnnas-board-release.conf 配置文件
   ```

4. **测试打包**：
   ```bash
   sudo ./renas -b s905x3-newbox -k 6.12.63
   ```

### GitHub Actions 资源获取

- **基础镜像**：从 `ophub/fnnas` 的 `fnnas_base_image` release 自动下载
- **DTB 文件**：从 `ophub/amlogic-s9xxx-armbian` 仓库自动下载到 `platform-files/`
- **U-Boot**：从 `ophub/u-boot` 仓库自动下载
- **固件**：从 `ophub/firmware` 仓库自动下载
- **内核**：从 `ophub/fnnas` 的 `kernel_fnnas` release 自动下载

## 测试指南

### 本地测试

```bash
# 测试单个设备构建
sudo ./renas -b s905x3 -k 6.12.63

# 验证输出
ls -lh fnnas/out/

# 测试内核打包
sudo ./rekernel -k 6.12.63 -e amlogic

# 清理临时文件
sudo rm -rf fnnas/tmp/
```

### 系统测试（在 FnNAS 中）

1. 使用 Rufus 或 balenaEtcher 将镜像写入 USB/SD
2. 从 USB/SD 启动设备
3. 测试系统工具：
   ```bash
   fnnas-update -k 6.12.y
   fnnas-install
   fnnas-swap 1
   ```

## 重要约束

- **需要 Root/sudo**：循环设备操作需要提升权限
- **平台依赖**：构建脚本为 Ubuntu 24.04 设计（可能适用于其他基于 Debian 的系统）
- **网络访问**：从 GitHub 自动下载资源（可本地缓存）
- **内核兼容性**：并非所有内核版本都适用于所有设备 - 遵守 KERNEL_TAGS 约束
- **镜像格式**：基础镜像必须是 Arm64 FnNAS（通常来自 fnnas.com 或 releases）

## 内核版本模式

构建系统支持灵活的内核版本规范：

- **精确版本**：`6.12.63` - 使用此特定版本
- **系列最新**：`6.12.y` - 使用 6.12 系列最新补丁
- **主要模式**：`6.x.y` - 使用 6.1.y、6.6.y 或 6.12.y 的最新版本
- **主要模式**：`5.x.y` - 使用 5.10.y 或 5.15.y 的最新版本
- **多个版本**：`6.12.63_6.18.3` - 使用多个内核构建

当设置 `-a true` 时，模糊规范会自动升级到最新可用的补丁版本。

## 恢复和回滚

系统维护内核更新安全：

- **备份位置**：`/ddbr/backup/`（FnNAS 系统内）
- **保留策略**：自动备份最近使用的 3 个内核
- **恢复命令**：`fnnas-update -s`（SOS 模式）
- **使用场景**：内核更新后启动失败

## 相关项目

本项目继承并协调：
- [ophub/amlogic-s9xxx-armbian](https://github.com/ophub/amlogic-s9xxx-armbian) - Armbian 适配（共享技术）
- [ophub/amlogic-s9xxx-openwrt](https://github.com/ophub/amlogic-s9xxx-openwrt) - 相同设备的 OpenWrt
- [unifreq/openwrt_packit](https://github.com/unifreq/openwrt_packit) - 原始打包框架
- [ophub/kernel](https://github.com/ophub/kernel) - 内核源仓库
- [ophub/u-boot](https://github.com/ophub/u-boot) - Bootloader 仓库
- [ophub/firmware](https://github.com/ophub/firmware) - 设备固件仓库

## 常见问题排查

**构建失败，提示"磁盘空间不足"**：
- 检查可用磁盘空间（构建过程需要 10GB+）
- 清理临时文件：`sudo rm -rf fnnas/tmp/`

**循环设备错误**：
- 确保使用 sudo 运行
- 检查可用循环设备：`losetup -a`
- 清理陈旧挂载：`sudo losetup -D`

**未找到内核版本**：
- 验证版本存在于[内核发布](https://github.com/ophub/fnnas/releases/tag/kernel_fnnas)中
- 检查 model_database.conf 中的 KERNEL_TAGS 兼容性
- 使用 `-a true` 自动选择最新可用版本

**未找到板型**：
- 验证 BOARD 值存在于 model_database.conf（第 14 列）
- 检查 `-b` 参数中的拼写错误
- 在 fnnas-install 中使用 `-l` 标志显示所有板型

## 许可证

GPL-2.0 - 本项目根据 GNU 通用公共许可证 v2.0 授权
